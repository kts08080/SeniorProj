/*
 *	File:	OLEDScreen.h
 *	Author: James Eastman (adapted from St. Denis)
 */

#include "OLEDScreen.h"

I2C_HandleTypeDef hi2c;
uint16_t address;
uint32_t timeout;

// Global Variables
static uint8_t asciiChar[256][5] = {
	{0x00, 0x00, 0x00, 0x00, 0x00},	//	NUL
	{0x3E, 0x5B, 0x4F, 0x5B, 0x3E},	//	SOH
	{0x3E, 0x6B, 0x4F, 0x6B, 0x3E},	//
	{0x1C, 0x3E, 0x7C, 0x3E, 0x1C},	//
	{0x18, 0x3C, 0x7E, 0x3C, 0x18},	//
	{0x1C, 0x57, 0x7D, 0x57, 0x1C},	//
	{0x1C, 0x5E, 0x7F, 0x5E, 0x1C},	//
	{0x00, 0x18, 0x3C, 0x18, 0x00},	//
	{0xFF, 0xE7, 0xC3, 0xE7, 0xFF},	//
	{0x00, 0x18, 0x24, 0x18, 0x00},	//
	{0xFF, 0xE7, 0xDB, 0xE7, 0xFF},	//
	{0x30, 0x48, 0x3A, 0x06, 0x0E},	//
	{0x26, 0x29, 0x79, 0x29, 0x26},	//
	{0x40, 0x7F, 0x05, 0x05, 0x07},	//
	{0x40, 0x7F, 0x05, 0x25, 0x3F},	//
	{0x5A, 0x3C, 0xE7, 0x3C, 0x5A},	//
	{0x7F, 0x3E, 0x1C, 0x1C, 0x08},	//
	{0x08, 0x1C, 0x1C, 0x3E, 0x7F},	//
	{0x14, 0x22, 0x7F, 0x22, 0x14},	//
	{0x5F, 0x5F, 0x00, 0x5F, 0x5F},	//
	{0x06, 0x09, 0x7F, 0x01, 0x7F},	//
	{0x00, 0x66, 0x89, 0x95, 0x6A},	//
	{0x60, 0x60, 0x60, 0x60, 0x60},	//
	{0x94, 0xA2, 0xFF, 0xA2, 0x94},	//
	{0x08, 0x04, 0x7E, 0x04, 0x08},	//
	{0x10, 0x20, 0x7E, 0x20, 0x10},	//
	{0x08, 0x08, 0x2A, 0x1C, 0x08},	//
	{0x08, 0x1C, 0x2A, 0x08, 0x08},	//
	{0x1E, 0x10, 0x10, 0x10, 0x10},	//
	{0x0C, 0x1E, 0x0C, 0x1E, 0x0C},	//
	{0x30, 0x38, 0x3E, 0x38, 0x30},	//
	{0x06, 0x0E, 0x3E, 0x0E, 0x06},	//
	{0x00, 0x00, 0x00, 0x00, 0x00},	//	space
	{0x00, 0x00, 0x5F, 0x00, 0x00},	//	!
	{0x00, 0x07, 0x00, 0x07, 0x00},	//	"
	{0x14, 0x7F, 0x14, 0x7F, 0x14},	//	#
	{0x24, 0x2A, 0x7F, 0x2A, 0x12},	//
	{0x23, 0x13, 0x08, 0x64, 0x62},	//	%
	{0x36, 0x49, 0x56, 0x20, 0x50},	//	&
	{0x00, 0x08, 0x07, 0x03, 0x00},	//	'
	{0x00, 0x1C, 0x22, 0x41, 0x00},	//
	{0x00, 0x41, 0x22, 0x1C, 0x00},	//
	{0x2A, 0x1C, 0x7F, 0x1C, 0x2A},	//
	{0x08, 0x08, 0x3E, 0x08, 0x08},	//
	{0x00, 0x80, 0x70, 0x30, 0x00},	//
	{0x08, 0x08, 0x08, 0x08, 0x08},	//
	{0x00, 0x00, 0x60, 0x60, 0x00},	//
	{0x20, 0x10, 0x08, 0x04, 0x02},	//
	{0x3E, 0x51, 0x49, 0x45, 0x3E}, //	0
	{0x00, 0x42, 0x7F, 0x40, 0x00},	//	1
	{0x72, 0x49, 0x49, 0x49, 0x46},	//	2
	{0x21, 0x41, 0x49, 0x4D, 0x33},	//	3
	{0x18, 0x14, 0x12, 0x7F, 0x10},	//	4
	{0x27, 0x45, 0x45, 0x45, 0x39},	//	5
	{0x3C, 0x4A, 0x49, 0x49, 0x31},	//	6
	{0x41, 0x21, 0x11, 0x09, 0x07},	//	7
	{0x36, 0x49, 0x49, 0x49, 0x36},	//	8
	{0x46, 0x49, 0x49, 0x29, 0x1E},	//	9
	{0x00, 0x00, 0x14, 0x00, 0x00},	//
	{0x00, 0x40, 0x34, 0x00, 0x00},	//
	{0x00, 0x08, 0x14, 0x22, 0x41},	//
	{0x14, 0x14, 0x14, 0x14, 0x14},	//
	{0x00, 0x41, 0x22, 0x14, 0x08},	//
	{0x02, 0x01, 0x59, 0x09, 0x06},	//
	{0x3E, 0x41, 0x5D, 0x59, 0x4E},	//
	{0x7C, 0x12, 0x11, 0x12, 0x7C},	//
	{0x7F, 0x49, 0x49, 0x49, 0x36},	//
	{0x3E, 0x41, 0x41, 0x41, 0x22},	//
	{0x7F, 0x41, 0x41, 0x41, 0x3E},	//
	{0x7F, 0x49, 0x49, 0x49, 0x41},	//
	{0x7F, 0x09, 0x09, 0x09, 0x01},	//
	{0x3E, 0x41, 0x41, 0x51, 0x73},	//
	{0x7F, 0x08, 0x08, 0x08, 0x7F},	//
	{0x00, 0x41, 0x7F, 0x41, 0x00},	//
	{0x20, 0x40, 0x41, 0x3F, 0x01},	//
	{0x7F, 0x08, 0x14, 0x22, 0x41},	//
	{0x7F, 0x40, 0x40, 0x40, 0x40},	//
	{0x7F, 0x02, 0x1C, 0x02, 0x7F},	//
	{0x7F, 0x04, 0x08, 0x10, 0x7F},	//
	{0x3E, 0x41, 0x41, 0x41, 0x3E},	//
	{0x7F, 0x09, 0x09, 0x09, 0x06},	//
	{0x3E, 0x41, 0x51, 0x21, 0x5E},	//
	{0x7F, 0x09, 0x19, 0x29, 0x46},	//
	{0x26, 0x49, 0x49, 0x49, 0x32},	//
	{0x03, 0x01, 0x7F, 0x01, 0x03},	//
	{0x3F, 0x40, 0x40, 0x40, 0x3F},	//
	{0x1F, 0x20, 0x40, 0x20, 0x1F},	//
	{0x3F, 0x40, 0x38, 0x40, 0x3F},	//
	{0x63, 0x14, 0x08, 0x14, 0x63},	//
	{0x03, 0x04, 0x78, 0x04, 0x03},	//
	{0x61, 0x59, 0x49, 0x4D, 0x43},	//
	{0x00, 0x7F, 0x41, 0x41, 0x41},	//
	{0x02, 0x04, 0x08, 0x10, 0x20},	//
	{0x00, 0x41, 0x41, 0x41, 0x7F},	//
	{0x04, 0x02, 0x01, 0x02, 0x04},	//
	{0x40, 0x40, 0x40, 0x40, 0x40},	//
	{0x00, 0x03, 0x07, 0x08, 0x00},	//
	{0x20, 0x54, 0x54, 0x78, 0x40},	//
	{0x7F, 0x28, 0x44, 0x44, 0x38},	//
	{0x38, 0x44, 0x44, 0x44, 0x28},	//
	{0x38, 0x44, 0x44, 0x28, 0x7F},	//
	{0x38, 0x54, 0x54, 0x54, 0x18},	//
	{0x00, 0x08, 0x7E, 0x09, 0x02},	//
	{0x18, 0xA4, 0xA4, 0x9C, 0x78},	//
	{0x7F, 0x08, 0x04, 0x04, 0x78},	//
	{0x00, 0x44, 0x7D, 0x40, 0x00},
	{0x20, 0x40, 0x40, 0x3D, 0x00},
	{0x7F, 0x10, 0x28, 0x44, 0x00},
	{0x00, 0x41, 0x7F, 0x40, 0x00},
	{0x7C, 0x04, 0x78, 0x04, 0x78},
	{0x7C, 0x08, 0x04, 0x04, 0x78},
	{0x38, 0x44, 0x44, 0x44, 0x38},
	{0xFC, 0x18, 0x24, 0x24, 0x18},
	{0x18, 0x24, 0x24, 0x18, 0xFC},
	{0x7C, 0x08, 0x04, 0x04, 0x08},
	{0x48, 0x54, 0x54, 0x54, 0x24},
	{0x04, 0x04, 0x3F, 0x44, 0x24},
	{0x3C, 0x40, 0x40, 0x20, 0x7C},
	{0x1C, 0x20, 0x40, 0x20, 0x1C},
	{0x3C, 0x40, 0x30, 0x40, 0x3C},
	{0x44, 0x28, 0x10, 0x28, 0x44},
	{0x4C, 0x90, 0x90, 0x90, 0x7C},
	{0x44, 0x64, 0x54, 0x4C, 0x44},
	{0x00, 0x08, 0x36, 0x41, 0x00},
	{0x00, 0x00, 0x77, 0x00, 0x00},
	{0x00, 0x41, 0x36, 0x08, 0x00},
	{0x02, 0x01, 0x02, 0x04, 0x02},
	{0x3C, 0x26, 0x23, 0x26, 0x3C},
	{0x1E, 0xA1, 0xA1, 0x61, 0x12},
	{0x3A, 0x40, 0x40, 0x20, 0x7A},
	{0x38, 0x54, 0x54, 0x55, 0x59},
	{0x21, 0x55, 0x55, 0x79, 0x41},
	{0x22, 0x54, 0x54, 0x78, 0x42},
	{0x21, 0x55, 0x54, 0x78, 0x40},
	{0x20, 0x54, 0x55, 0x79, 0x40},
	{0x0C, 0x1E, 0x52, 0x72, 0x12},
	{0x39, 0x55, 0x55, 0x55, 0x59},
	{0x39, 0x54, 0x54, 0x54, 0x59},
	{0x39, 0x55, 0x54, 0x54, 0x58},
	{0x00, 0x00, 0x45, 0x7C, 0x41},
	{0x00, 0x02, 0x45, 0x7D, 0x42},
	{0x00, 0x01, 0x45, 0x7C, 0x40},
	{0x7D, 0x12, 0x11, 0x12, 0x7D},
	{0xF0, 0x28, 0x25, 0x28, 0xF0},
	{0x7C, 0x54, 0x55, 0x45, 0x00},
	{0x20, 0x54, 0x54, 0x7C, 0x54},
	{0x7C, 0x0A, 0x09, 0x7F, 0x49},
	{0x32, 0x49, 0x49, 0x49, 0x32},
	{0x3A, 0x44, 0x44, 0x44, 0x3A},
	{0x32, 0x4A, 0x48, 0x48, 0x30},
	{0x3A, 0x41, 0x41, 0x21, 0x7A},
	{0x3A, 0x42, 0x40, 0x20, 0x78},
	{0x00, 0x9D, 0xA0, 0xA0, 0x7D},
	{0x3D, 0x42, 0x42, 0x42, 0x3D},
	{0x3D, 0x40, 0x40, 0x40, 0x3D},
	{0x3C, 0x24, 0xFF, 0x24, 0x24},
	{0x48, 0x7E, 0x49, 0x43, 0x66},
	{0x2B, 0x2F, 0xFC, 0x2F, 0x2B},
	{0xFF, 0x09, 0x29, 0xF6, 0x20},
	{0xC0, 0x88, 0x7E, 0x09, 0x03},
	{0x20, 0x54, 0x54, 0x79, 0x41},
	{0x00, 0x00, 0x44, 0x7D, 0x41},
	{0x30, 0x48, 0x48, 0x4A, 0x32},
	{0x38, 0x40, 0x40, 0x22, 0x7A},
	{0x00, 0x7A, 0x0A, 0x0A, 0x72},
	{0x7D, 0x0D, 0x19, 0x31, 0x7D},
	{0x26, 0x29, 0x29, 0x2F, 0x28},
	{0x26, 0x29, 0x29, 0x29, 0x26},
	{0x30, 0x48, 0x4D, 0x40, 0x20},
	{0x38, 0x08, 0x08, 0x08, 0x08},
	{0x08, 0x08, 0x08, 0x08, 0x38},
	{0x2F, 0x10, 0xC8, 0xAC, 0xBA},
	{0x2F, 0x10, 0x28, 0x34, 0xFA},
	{0x00, 0x00, 0x7B, 0x00, 0x00},
	{0x08, 0x14, 0x2A, 0x14, 0x22},
	{0x22, 0x14, 0x2A, 0x14, 0x08},
	{0x55, 0x00, 0x55, 0x00, 0x55},
	{0xAA, 0x55, 0xAA, 0x55, 0xAA},
	{0xFF, 0x55, 0xFF, 0x55, 0xFF},
	{0x00, 0x00, 0x00, 0xFF, 0x00},
	{0x10, 0x10, 0x10, 0xFF, 0x00},
	{0x14, 0x14, 0x14, 0xFF, 0x00},
	{0x10, 0x10, 0xFF, 0x00, 0xFF},
	{0x10, 0x10, 0xF0, 0x10, 0xF0},
	{0x14, 0x14, 0x14, 0xFC, 0x00},
	{0x14, 0x14, 0xF7, 0x00, 0xFF},
	{0x00, 0x00, 0xFF, 0x00, 0xFF},
	{0x14, 0x14, 0xF4, 0x04, 0xFC},
	{0x14, 0x14, 0x17, 0x10, 0x1F},
	{0x10, 0x10, 0x1F, 0x10, 0x1F},
	{0x14, 0x14, 0x14, 0x1F, 0x00},
	{0x10, 0x10, 0x10, 0xF0, 0x00},
	{0x00, 0x00, 0x00, 0x1F, 0x10},
	{0x10, 0x10, 0x10, 0x1F, 0x10},
	{0x10, 0x10, 0x10, 0xF0, 0x10},
	{0x00, 0x00, 0x00, 0xFF, 0x10},
	{0x10, 0x10, 0x10, 0x10, 0x10},
	{0x10, 0x10, 0x10, 0xFF, 0x10},
	{0x00, 0x00, 0x00, 0xFF, 0x14},
	{0x00, 0x00, 0xFF, 0x00, 0xFF},
	{0x00, 0x00, 0x1F, 0x10, 0x17},
	{0x00, 0x00, 0xFC, 0x04, 0xF4},
	{0x14, 0x14, 0x17, 0x10, 0x17},
	{0x14, 0x14, 0xF4, 0x04, 0xF4},
	{0x00, 0x00, 0xFF, 0x00, 0xF7},
	{0x14, 0x14, 0x14, 0x14, 0x14},
	{0x14, 0x14, 0xF7, 0x00, 0xF7},
	{0x14, 0x14, 0x14, 0x17, 0x14},
	{0x10, 0x10, 0x1F, 0x10, 0x1F},
	{0x14, 0x14, 0x14, 0xF4, 0x14},
	{0x10, 0x10, 0xF0, 0x10, 0xF0},
	{0x00, 0x00, 0x1F, 0x10, 0x1F},
	{0x00, 0x00, 0x00, 0x1F, 0x14},
	{0x00, 0x00, 0x00, 0xFC, 0x14},
	{0x00, 0x00, 0xF0, 0x10, 0xF0},
	{0x10, 0x10, 0xFF, 0x10, 0xFF},
	{0x14, 0x14, 0x14, 0xFF, 0x14},
	{0x10, 0x10, 0x10, 0x1F, 0x00},
	{0x00, 0x00, 0x00, 0xF0, 0x10},
	{0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
	{0xF0, 0xF0, 0xF0, 0xF0, 0xF0},
	{0xFF, 0xFF, 0xFF, 0x00, 0x00},
	{0x00, 0x00, 0x00, 0xFF, 0xFF},
	{0x0F, 0x0F, 0x0F, 0x0F, 0x0F},
	{0x38, 0x44, 0x44, 0x38, 0x44},
	{0xFC, 0x4A, 0x4A, 0x4A, 0x34},
	{0x7E, 0x02, 0x02, 0x06, 0x06},
	{0x02, 0x7E, 0x02, 0x7E, 0x02},
	{0x63, 0x55, 0x49, 0x41, 0x63},
	{0x38, 0x44, 0x44, 0x3C, 0x04},
	{0x40, 0x7E, 0x20, 0x1E, 0x20},
	{0x06, 0x02, 0x7E, 0x02, 0x02},
	{0x99, 0xA5, 0xE7, 0xA5, 0x99},
	{0x1C, 0x2A, 0x49, 0x2A, 0x1C},
	{0x4C, 0x72, 0x01, 0x72, 0x4C},
	{0x30, 0x4A, 0x4D, 0x4D, 0x30},
	{0x30, 0x48, 0x78, 0x48, 0x30},
	{0xBC, 0x62, 0x5A, 0x46, 0x3D},
	{0x3E, 0x49, 0x49, 0x49, 0x00},
	{0x7E, 0x01, 0x01, 0x01, 0x7E},
	{0x2A, 0x2A, 0x2A, 0x2A, 0x2A},
	{0x44, 0x44, 0x5F, 0x44, 0x44},
	{0x40, 0x51, 0x4A, 0x44, 0x40},
	{0x40, 0x44, 0x4A, 0x51, 0x40},
	{0x00, 0x00, 0xFF, 0x01, 0x03},
	{0xE0, 0x80, 0xFF, 0x00, 0x00},
	{0x08, 0x08, 0x6B, 0x6B, 0x08},
	{0x36, 0x12, 0x36, 0x24, 0x36},
	{0x06, 0x0F, 0x09, 0x0F, 0x06},
	{0x00, 0x00, 0x18, 0x18, 0x00},
	{0x00, 0x00, 0x10, 0x10, 0x00},
	{0x30, 0x40, 0xFF, 0x01, 0x01},
	{0x00, 0x1F, 0x01, 0x01, 0x1E},
	{0x00, 0x19, 0x1D, 0x17, 0x12},
	{0x00, 0x3C, 0x3C, 0x3C, 0x3C},
	{0x00, 0x00, 0x00, 0x00, 0x00}
};

int colCount = 0;
int pageCount = 0;

void OLED_I2C_Init(I2C_HandleTypeDef hi2c_input, uint16_t address_input){
	// setup
	hi2c = hi2c_input;
	address = address_input << 1;
	timeout = 1000;
	// Delay to let OLED boot
	HAL_Delay(100);


	OLED_sendCommand(DISPLAY_OFF);

	OLED_sendCommand(CLOCK_DIVIDE);
	OLED_sendCommand(0x80);	// Value

	OLED_sendCommand(MULTIPLEX_RATIO);
	OLED_sendCommand(0x3F);	// Value

	OLED_sendCommand(DISPLAY_OFFSET);
	OLED_sendCommand(0x00);	// Value

	OLED_sendCommand(SET_START_LINE);

	OLED_sendCommand(CHARGE_PUMP);	// Set Charge Pump
	OLED_sendCommand(0x14);	// Value

	OLED_sendCommand(MEMORY_MODE);
	OLED_sendCommand(0x00);	// Value

	OLED_sendCommand(SEG_REMAP | 0x01);	// Rotate screen 180

	OLED_sendCommand(COM_SCAN_REMAPPED);	// Rotate screen 180

	OLED_sendCommand(SET_CONTRASTAT);
	OLED_sendCommand(0x66);	// Value

	OLED_sendCommand(PRECHARGE_PERIOD);
	OLED_sendCommand(0xF1);	// Value

	OLED_sendCommand(VCOMH_DESELECT);
	OLED_sendCommand(0x40);	// Value

	OLED_sendCommand(SET_COM_PINS);
	OLED_sendCommand(0x12);	// Value

	OLED_sendCommand(VCOMH_DESELECT);
	OLED_sendCommand(0x30);	// Value

	OLED_sendCommand(RAM_CONTENT_ON);
	OLED_sendCommand(NORMAL_DISPLAY);

	OLED_sendCommand(DISPLAY_ON);
	HAL_Delay(100);

	OLED_clearScreen();

}
// Sends commands for changing settings.
void OLED_sendCommand(uint8_t data){
	uint8_t control = 0x00; // Value for command
	uint8_t pData[2];		// The actual data to send
	pData[0] = control;		// We first send the control byte tell the SSD1306 that the next byte is a command
	pData[1] = data;		// Now we set the data
	HAL_StatusTypeDef error;
	// Transmit data
	error = HAL_I2C_Master_Transmit(&hi2c, address, pData, 2, timeout);
	// If There's an error, send hard fault
	if(error == HAL_ERROR){
		return;
	}
}
// Sends data to the screen
void OLED_sendData(uint8_t data){
	uint8_t control = 0x40;
	uint8_t pData[2];
	pData[0] = control;
	pData[1] = data;
	HAL_I2C_Master_Transmit(&hi2c, address, pData, 2, timeout);
	colCount++;
}
// Set the column address pointer in the SSD1306
void OLED_setColAddress(uint16_t xCol){
	if(xCol>(OLED_WIDTH-1))return;
	OLED_sendCommand(COLUMN_ADDRESS);
	OLED_sendCommand(xCol);
	OLED_sendCommand(OLED_WIDTH - 1);
	colCount = xCol;
}
// Set the page address in the SSD1306
void OLED_setPageAddress(uint16_t yPage){
	if(yPage > (OLED_HEIGHT/8-1))return;
	OLED_sendCommand(PAGE_ADDRESS);
	OLED_sendCommand(yPage);
	OLED_sendCommand(OLED_HEIGHT/8-1);
	pageCount = yPage;
}
// Set the location of the cursor by setting both the column and the page address
void OLED_setLocation(uint16_t xCol, uint16_t yPage){
	OLED_setColAddress(xCol);
	OLED_setPageAddress(yPage);
}
// Print a single charter to the screen
void OLED_printChar(char character){
	uint8_t column;

	OLED_sendData(0);
	for(column = 0; column < 5; column++){
		OLED_sendData(asciiChar[(unsigned char)character][column]);
	}
	OLED_sendData(0);
}
// Write an entire string to the screen.
void OLED_writeString(char *c){
	while(*c){
		OLED_printChar(*c);
		c++;
	}
}
// Clears the entire screen
void OLED_clearScreen(void){
	OLED_setLocation(0,0);
	for(int j=0; j<=7; j++){
		OLED_setLocation(0, j);
		for(int i=0; i < OLED_WIDTH; i++){
			OLED_sendData(0x00);
		}
	}

}
// Clears single line from screen
void OLED_clearLine(int x){
	OLED_setLocation(0,x);
	for(int i=0; i < OLED_WIDTH; i++){
		OLED_sendData(0x00);
	}
}
// Clears the number of characters specified
void OLED_clearChar(int x){
	for(int i = colCount; i>x; i--){
		OLED_setLocation(i, pageCount);
		OLED_sendData(0x00);
	}
}
